<p-toast></p-toast>
<div class="container-wrapper">
  <div class="overflow-x-auto mt-10 flex flex-col gap-10 pb-10">
    <div class="bg-black/90 p-2">
      <p class="text-white/90">Device Mapping</p>
    </div>

    <div class="w-full overflow-x-auto">
      <table class="table table-xs w-full min-w-[600px]">
        <thead class="text-xs">
          <tr class="text-neutral-700 text-center">
            @for (item of header(); track $index) {
            <th>{{ item }}</th>
            }
          </tr>
        </thead>
        <tbody class="text-center">
          @for (mapping of mappings(); track $index; let idx = $index) {
          <tr>
            <td>{{ idx + 1 }}</td>
            <td>
              <input
                type="text"
                class="custom-input"
                [(ngModel)]="mapping.parameter"
                placeholder="Enter the Parameter"
              />
            </td>
            <td>
              <input
                type="number"
                class="custom-input"
                [(ngModel)]="mapping.registerAddress"
                placeholder="Register Address e.g 1001"
              />
            </td>
            <!-- FIXED: Register Type with change handler -->
            <td>
              <select
                class="focus:outline-none custom-input"
                [(ngModel)]="mapping.registerType"
                (change)="onRegisterTypeChange(mapping, idx)"
              >
                <option value="">Select Register Type</option>
                @for (register of registers(); track $index) {
                <option [value]="register">{{ register }}</option>
                }
              </select>
            </td>
            <!-- FIXED: Dynamic Data Type Selection -->
            <td>
              <select
                class="focus:outline-none custom-input"
                [(ngModel)]="mapping.dataType"
                [disabled]="!mapping.registerType"
              >
                <option value="">Select Data Type</option>
                @for (dataType of getAvailableDataTypes(mapping.registerType); track $index) {
                <option [value]="dataType.value">{{ dataType.label }}</option>
                }
              </select>
            </td>
            <td>
              <input
                type="number"
                class="custom-input w-20"
                [(ngModel)]="mapping.interval"
                placeholder="in ms"
              />
            </td>
            <td>
              <!-- Delete button for this row -->
              <button
                (click)="removeRow(idx, mapping.id)"
                class="text-red-500 hover:text-red-700"
              >
                <lucide-angular
                  [img]="removeIcon"
                  class="h-4 w-4"
                ></lucide-angular>
              </button>
            </td>
          </tr>
          <!-- FIXED: Add validation hint row -->
          @if (mapping.registerType) {
          <tr>
            <td colspan="7" class="text-xs text-gray-500 italic">
              @if (mapping.registerType === 'COILS' || mapping.registerType === 'DISCRETE_INPUTS') {
                ℹ️ Coils and Discrete Inputs only support Boolean values (true/false)
              }
              @if (mapping.registerType === 'HOLDING_REGISTERS' || mapping.registerType === 'INPUT_REGISTERS') {
                ℹ️ Registers support numeric data types (integers, floats, etc.)
              }
            </td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>

    <div class="flex flex-row items-center gap-4 justify-end">
      <!-- Only keep add button -->
      <button
        (click)="addRow()"
        class="bg-neutral-400/50 text-neutral-700 rounded-sm px-3 py-1 text-xs cursor-pointer"
      >
        <lucide-angular
          [img]="addIcon"
          class="my-icon h-3 w-3"
        ></lucide-angular>
      </button>
    </div>

    <div class="flex items-end justify-center h-1/2">
      <p
        class="w-fit px-4 py-1 bg-black/90 rounded-sm text-white/90 cursor-pointer hover:bg-black/60 transition-all duration-300"
        (click)="saveDeviceWithMappings()"
      >
        Save
      </p>
    </div>
  </div>
</div>
